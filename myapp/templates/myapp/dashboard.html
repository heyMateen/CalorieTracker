{% extends "myapp/base.html" %}
{% block title %}Dashboard - Calorie Tracker{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Confetti Library -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    .locked-feature {
        position: relative;
        opacity: 0.6;
        pointer-events: none;
    }
    .locked-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 10;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .premium-banner {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        color: black;
        box-shadow: 0 4px 15px rgba(255,215,0,0.3);
    }
    .premium-banner h5 {
        color: black;
        font-weight: bold;
    }
    .feature-card.premium {
        border: 2px solid #FFD700;
        position: relative;
    }
    /* Meal Planner banner styling */
    .meal-planner-banner {
        background: linear-gradient(90deg, #FFF3B0 0%, #FFD666 50%, #FFDF80 100%);
        border-radius: 12px;
        padding: 14px 18px;
        box-shadow: 0 6px 18px rgba(255, 215, 0, 0.12);
        color: #1f1f1f;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .meal-planner-banner h5 {
        margin-bottom: 0;
        font-weight: 600;
    }
    .meal-planner-banner p { margin-bottom: 0; color: rgba(0,0,0,0.7); }
    
    /* ===== STUNNING NEW FEATURES STYLES ===== */
    
    /* Animated Progress Ring */
    .progress-ring {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto;
    }
    .progress-ring svg {
        transform: rotate(-90deg);
    }
    .progress-ring circle {
        fill: none;
        stroke-width: 12;
        stroke-linecap: round;
    }
    .progress-ring .bg {
        stroke: #e9ecef;
    }
    .progress-ring .progress {
        stroke: url(#gradient);
        stroke-dasharray: 440;
        stroke-dashoffset: 440;
        transition: stroke-dashoffset 1.5s ease-out;
    }
    .progress-ring .center-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    .progress-ring .calories-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
    }
    .progress-ring .calories-label {
        font-size: 0.85rem;
        color: #666;
    }
    
    /* Streak Fire Animation */
    .streak-card {
        background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
        border-radius: 20px;
        padding: 20px;
        color: white;
        position: relative;
        overflow: hidden;
    }
    .streak-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: pulse 3s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }
    .fire-icon {
        font-size: 3rem;
        animation: fireFlicker 0.5s ease-in-out infinite alternate;
    }
    @keyframes fireFlicker {
        0% { transform: scale(1) rotate(-3deg); }
        100% { transform: scale(1.1) rotate(3deg); }
    }
    
    /* Achievement Badges */
    .achievement-badge {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .achievement-badge:hover {
        transform: scale(1.15) rotate(10deg);
    }
    .achievement-badge.locked {
        background: #ccc !important;
        opacity: 0.5;
    }
    
    /* Motivational Banner */
    .motivation-banner {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border-radius: 20px;
        padding: 25px;
        color: white;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }
    .motivation-banner .emoji {
        font-size: 3rem;
        animation: bounce 2s ease infinite;
    }
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    /* Points Counter Animation */
    .points-counter {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 15px;
        padding: 15px 25px;
        display: inline-block;
        color: white;
        font-weight: bold;
    }
    
    /* Glassmorphism Cards */
    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }
    
    /* Nutrient Mini Cards */
    .nutrient-mini {
        background: white;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .nutrient-mini:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .nutrient-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 1.5rem;
    }
    
    /* Dark Mode Toggle */
    .dark-mode-toggle {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        z-index: 1000;
    }
    .dark-mode-toggle:hover {
        transform: scale(1.1) rotate(20deg);
    }
    
    /* Stats Icon Enhancement */
    .stats-icon {
        width: 55px;
        height: 55px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    .card:hover .stats-icon {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Motivational Banner -->
<div class="motivation-banner">
    <div class="row align-items-center">
        <div class="col-auto">
            <span class="emoji">{{ motivational_data.emoji }}</span>
        </div>
        <div class="col">
            <h4 class="mb-1">{{ motivational_data.title }}</h4>
            <p class="mb-0 opacity-75">{{ motivational_data.message }}</p>
        </div>
        <div class="col-auto">
            <div class="text-end">
                <small class="d-block opacity-75">{{ motivational_data.streak_message }}</small>
            </div>
        </div>
    </div>
</div>

<!-- Premium Status Banner -->
<!-- Top CTA: Smart Meal Planner (single premium feature) -->
<div class="meal-planner-banner">
    <div class="d-flex align-items-center">
        <h5 class="mb-0 me-3"><i class="fas fa-utensils"></i> Smart Meal Planner</h5>
        <p class="mb-0">Create smart daily meal plans and get real-time nutrition previews</p>
    </div>
    <div>
        <a href="{% url 'meal_planner' %}" class="btn btn-dark btn-lg" style="font-weight:600;">
            <i class="fas fa-utensils me-1"></i> Open Meal Planner
        </a>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Main Stats Row with Progress Ring -->
    <div class="row g-4 mb-4">
        <!-- Animated Progress Ring -->
        <div class="col-lg-4">
            <div class="glass-card h-100 p-4">
                <h5 class="text-center mb-4"><i class="fas fa-fire-alt text-danger"></i> Daily Calorie Progress</h5>
                <div class="progress-ring">
                    <svg width="180" height="180">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FF6B6B"/>
                                <stop offset="50%" style="stop-color:#FFE66D"/>
                                <stop offset="100%" style="stop-color:#4ECDC4"/>
                            </linearGradient>
                        </defs>
                        <circle class="bg" cx="90" cy="90" r="70"/>
                        <circle class="progress" cx="90" cy="90" r="70" id="progressCircle"/>
                    </svg>
                    <div class="center-text">
                        <div class="calories-value" id="caloriesAnimated">0</div>
                        <div class="calories-label">/ {{ user_profile.daily_calorie_goal }} kcal</div>
                    </div>
                </div>
                <!-- Nutrient Mini Cards -->
                <div class="row g-2 mt-4">
                    <div class="col-4">
                        <div class="nutrient-mini">
                            <div class="nutrient-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                                üçû
                            </div>
                            <h6 class="mb-0">{{ daily_carbs|floatformat:0 }}g</h6>
                            <small class="text-muted">Carbs</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="nutrient-mini">
                            <div class="nutrient-icon" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
                                ü•©
                            </div>
                            <h6 class="mb-0">{{ daily_protein|floatformat:0 }}g</h6>
                            <small class="text-muted">Protein</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="nutrient-mini">
                            <div class="nutrient-icon" style="background: linear-gradient(135deg, #fddb92 0%, #d1fdff 100%);">
                                ü•ë
                            </div>
                            <h6 class="mb-0">{{ daily_fats|floatformat:0 }}g</h6>
                            <small class="text-muted">Fats</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Streak & Achievements -->
        <div class="col-lg-4">
            <!-- Streak Card -->
            <div class="streak-card mb-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-1 opacity-75">Current Streak</h6>
                        <h2 class="mb-0">{{ user_streak.current_streak }} Days</h2>
                        <small class="opacity-75">Longest: {{ user_streak.longest_streak }} days</small>
                    </div>
                    <div class="fire-icon">üî•</div>
                </div>
            </div>
            
            <!-- Achievement Points -->
            <div class="glass-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0"><i class="fas fa-trophy text-warning"></i> Achievements</h6>
                    <div class="points-counter">
                        <i class="fas fa-star me-1"></i> {{ total_achievement_points }} pts
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    {% for ua in user_achievements %}
                    <div class="achievement-badge" style="background: {{ ua.achievement.color }};" 
                         title="{{ ua.achievement.name }}: {{ ua.achievement.description }}">
                        <i class="fas {{ ua.achievement.icon }}"></i>
                    </div>
                    {% empty %}
                    <div class="achievement-badge locked"><i class="fas fa-lock"></i></div>
                    <div class="achievement-badge locked"><i class="fas fa-lock"></i></div>
                    <div class="achievement-badge locked"><i class="fas fa-lock"></i></div>
                    {% endfor %}
                    {% if user_achievements|length < 6 %}
                        {% for i in "123456"|make_list %}
                            {% if forloop.counter > user_achievements|length %}
                            <div class="achievement-badge locked"><i class="fas fa-lock"></i></div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">Log meals daily to unlock achievements!</small>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions Card -->
        <div class="col-lg-4">
            <div class="glass-card h-100 p-4">
                <div class="d-flex align-items-center mb-3">
                    <h6 class="mb-0"><i class="fas fa-bolt text-warning"></i> Quick Actions</h6>
                </div>
                <div class="d-grid gap-2">
                    <a href="{% url 'add_food' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus-circle me-2"></i> Log Food
                    </a>
                    <a href="{% url 'meal_planner' %}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-magic me-2"></i> AI Meal Planner
                    </a>
                    <a href="{% url 'advanced_analytics' %}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-chart-bar me-2"></i> View Analytics
                    </a>
                    <a href="{% url 'edit_profile' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-user-edit me-2"></i> Update Profile
                    </a>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted d-block text-center">
                        <i class="fas fa-info-circle me-1"></i>
                        Visit Meal Planner for AI suggestions!
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Stats Cards Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <div class="stats-icon bg-primary text-white rounded-circle p-3">
                                <i class="fas fa-fire fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Daily Calories</h6>
                            <h3 class="mb-0">{{ daily_calories }} / {{ user_profile.daily_calorie_goal }}</h3>
                        </div>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: {{ calorie_percentage }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <div class="stats-icon bg-success text-white rounded-circle p-3">
                                <i class="fas fa-weight fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Current Weight</h6>
                            <h3 class="mb-0">{{ latest_weight.weight|default:"--" }} kg</h3>
                        </div>
                    </div>
                    <p class="text-muted mb-0">
                        {% if current_bmi %}
                            BMI: <strong>{{ current_bmi }}</strong>
                            <span class="badge {% if bmi_category == 'Normal' %}bg-success{% elif bmi_category == 'Underweight' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ bmi_category }}
                            </span>
                        {% else %}
                            BMI: -- <small><a href="{% url 'edit_profile' %}" class="text-primary">(Set your height to calculate BMI)</a></small>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <div class="stats-icon bg-warning text-white rounded-circle p-3">
                                <i class="fas fa-bullseye fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Goal</h6>
                            <h3 class="mb-0 text-capitalize">{{ user_profile.weight_goal }}</h3>
                        </div>
                    </div>
                    <p class="text-muted mb-0">Activity: {{ user_profile.get_activity_level_display }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <div class="stats-icon bg-info text-white rounded-circle p-3">
                                <i class="fas fa-chart-line fa-lg"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Weekly Average</h6>
                            <h3 class="mb-0">{{ weekly_avg_calories }} kcal</h3>
                        </div>
                    </div>
                    <p class="text-muted mb-0">Past 7 days</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">Calorie Intake History</h5>
                </div>
                <div class="card-body">
                    <canvas id="calorieHistory" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">Today's Nutrients</h5>
                </div>
                <div class="card-body">
                    <canvas id="nutrientsPie" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Meals Section -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Today's Meals</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMealModal">
                        <i class="fas fa-plus me-1"></i> Add Meal
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="accordion" id="mealsAccordion">
                        {% for meal_type, foods in daily_meals.items %}
                        <div class="accordion-item border-0">
                            <h2 class="accordion-header" id="heading{{ meal_type }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapse{{ meal_type }}">
                                    {{ meal_type|title }}
                                    <span class="badge bg-primary ms-2">{{ foods|length }} items</span>
                                </button>
                            </h2>
                            <div id="collapse{{ meal_type }}" class="accordion-collapse collapse"
                                 data-bs-parent="#mealsAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-borderless align-middle">
                                            {% for food in foods %}
                                            <tr>
                                                <td>{{ food.food_consumed.name }}</td>
                                                <td>{{ food.food_consumed.calories }} kcal</td>
                                                <td class="text-end">
                                                    <button class="btn btn-outline-danger btn-sm">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Weight Tracking</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addWeightModal">
                        <i class="fas fa-plus me-1"></i> Log Weight
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="weightHistory" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- Add Meal Modal -->
<div class="modal fade" id="addMealModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Meal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'add_meal' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Meal Type</label>
                        <select class="form-select" name="meal_type" required>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Food Item</label>
                        <select class="form-select" name="food_consumed" required>
                            {% for food in foods %}
                            <option value="{{ food.id }}">{{ food.name }} ({{ food.calories }} kcal)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Servings</label>
                        <input type="number" class="form-control" name="servings" value="1" step="0.1" min="0.1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Meal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Weight Modal -->
<div class="modal fade" id="addWeightModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Weight</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'log_weight' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" class="form-control" name="weight" step="0.1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" name="date" value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (optional)</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== STUNNING ANIMATIONS =====

// Animate Calorie Counter
function animateValue(element, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        element.textContent = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

// Animate Progress Ring
function animateProgressRing() {
    const circle = document.getElementById('progressCircle');
    const percentage = {{ calorie_percentage }};
    const circumference = 2 * Math.PI * 70; // radius = 70
    const offset = circumference - (percentage / 100) * circumference;
    
    setTimeout(() => {
        circle.style.strokeDashoffset = offset;
    }, 300);
}

// Run animations on page load
document.addEventListener('DOMContentLoaded', function() {
    // Animate calorie counter
    const caloriesEl = document.getElementById('caloriesAnimated');
    animateValue(caloriesEl, 0, {{ daily_calories }}, 1500);
    
    // Animate progress ring
    animateProgressRing();
    
    // Confetti celebration if goal is met!
    {% if goal_met %}
    setTimeout(() => {
        // Fire confetti from both sides
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { x: 0.1, y: 0.6 }
        });
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { x: 0.9, y: 0.6 }
        });
        
        // Continuous celebration
        setTimeout(() => {
            confetti({
                particleCount: 50,
                angle: 60,
                spread: 55,
                origin: { x: 0 }
            });
            confetti({
                particleCount: 50,
                angle: 120,
                spread: 55,
                origin: { x: 1 }
            });
        }, 500);
    }, 1000);
    {% endif %}
});

// Calorie History Chart
const calorieHistoryCtx = document.getElementById('calorieHistory').getContext('2d');
new Chart(calorieHistoryCtx, {
    type: 'line',
    data: {
        labels: {{ calorie_history_dates|safe }},
        datasets: [{
            label: 'Calories',
            data: {{ calorie_history_values|safe }},
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.4,
            fill: true,
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgb(75, 192, 192)',
            pointRadius: 5,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        animation: {
            duration: 2000,
            easing: 'easeOutQuart'
        },
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    display: false
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Nutrients Pie Chart
const nutrientsCtx = document.getElementById('nutrientsPie').getContext('2d');
new Chart(nutrientsCtx, {
    type: 'doughnut',
    data: {
        labels: ['Carbs', 'Protein', 'Fats'],
        datasets: [{
            data: [{{ daily_carbs }}, {{ daily_protein }}, {{ daily_fats }}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        animation: {
            animateRotate: true,
            duration: 1500
        },
        plugins: {
            legend: {
                position: 'bottom'
            }
        },
        cutout: '70%'
    }
});

// Weight History Chart
const weightHistoryCtx = document.getElementById('weightHistory').getContext('2d');
new Chart(weightHistoryCtx, {
    type: 'line',
    data: {
        labels: {{ weight_history_dates|safe }},
        datasets: [{
            label: 'Weight (kg)',
            data: {{ weight_history_values|safe }},
            borderColor: 'rgb(153, 102, 255)',
            tension: 0.4,
            fill: true,
            backgroundColor: 'rgba(153, 102, 255, 0.1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgb(153, 102, 255)',
            pointRadius: 5,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        animation: {
            duration: 2000,
            easing: 'easeOutQuart'
        },
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                grid: {
                    display: false
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Achievement badge tooltips
document.querySelectorAll('.achievement-badge').forEach(badge => {
    badge.addEventListener('mouseenter', function() {
        this.style.zIndex = '100';
    });
    badge.addEventListener('mouseleave', function() {
        this.style.zIndex = '1';
    });
});
</script>
{% endblock %}